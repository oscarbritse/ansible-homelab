# install docker (stable via Debian/Raspberry Pi OS) + docker compose (v2 plugin as binary)
- name: Install Docker prerequisites
  tags: docker
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true

- name: Install Docker engine (Debian/RPi OS packages)
  tags: docker
  ansible.builtin.apt:
    name:
      - docker.io
    state: present
    update_cache: true

- name: Ensure Docker is enabled and running
  tags: docker
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

# Install Docker Compose v2 as a Docker CLI plugin binary (enables `docker compose`)
- name: Ensure Docker CLI plugins directory exists
  tags: docker
  ansible.builtin.file:
    path: /usr/local/lib/docker/cli-plugins
    state: directory
    mode: "0755"

- name: Download Docker Compose v2 plugin (aarch64)
  tags: docker
  ansible.builtin.get_url:
    url: "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-aarch64"
    dest: /usr/local/lib/docker/cli-plugins/docker-compose
    mode: "0755"

- name: Verify Docker Compose v2 is available
  tags: docker
  ansible.builtin.command: docker compose version
  register: compose_version
  changed_when: false

- name: Show Docker Compose v2 version
  tags: docker
  ansible.builtin.debug:
    var: compose_version.stdout

# optional: you may to add your user to docker group
- name: Create "docker" group
  tags: docker
  ansible.builtin.group:
    name: "{{ docker_group }}"
    state: present

- name: Add remote user to "docker" group
  tags: docker
  ansible.builtin.user:
    name: "{{ ansible_remote_user }}"
    groups: "{{ docker_group }}"
    append: yes

# add config files for docker containers
- name: Create Docker sync directory
  tags: docker
  file:
    path: "{{ docker_config_directory }}"
    state: directory

- name: Sync Docker files
  tags: docker
  synchronize:
    src: files/docker/
    dest: "{{ docker_config_directory }}"
    rsync_opts:
      - '--include=*.yml'
      - '--include=*.png'
      - '--include=*.svg'
      - '--include=*.css'
      - '--include=*' # include all file types (favicons etc)
      - '--include=*/'
      # - '--exclude=*'

- name: Set permissions for Prometheus data
  ansible.builtin.file:
    path: "{{ docker_config_directory }}/monitoring/prometheus/"
    recurse: true
    owner: 65534
    group: 65534

- name: Set permissions for Grafana data
  ansible.builtin.file:
    path: "{{ docker_config_directory }}/monitoring/grafana/"
    recurse: true
    owner: 472
    group: 472

# enable memory and I/O usage for containers in prometheus and grafana
- name: Enable memory and I/O usage for containers in boot file
  ansible.builtin.lineinfile:
    path: /boot/firmware/cmdline.txt
    regexp: '^console=serial0,115200 console=tty1 root=PARTUUID=a092253f-02 rootfstype=ext4 fsck.repair=yes rootwait$'
    line: 'systemd.unified_cgroup_hierarchy=0 cgroup_enable=memory cgroup_memory=1 console=serial0,115200 console=tty1 root=PARTUUID=a092253f-02 rootfstype=ext4 fsck.repair=yes rootwait'
    backrefs: yes

# add fancy motd
- name: Delete motd file
  tags: motd
  ansible.builtin.file:
    path: /etc/motd
    state: absent

- name: Delete update motd file
  tags: motd
  ansible.builtin.file:
    path: /etc/update-motd.d/10-uname
    state: absent

- name: Install motd required packages
  tags: motd
  ansible.builtin.apt:
    name:
      - figlet
      - lolcat
    state: latest
    update_cache: true

- name: Copy motd file
  tags: motd
  copy:
    src: files/motd/motd.sh
    dest: /etc/profile.d
    owner: root
    group: root
    mode: 0644

# sudo usermod -aG video <username>
# required to be able to run vcgencmd
- name: Add remote user to "video" group
  tags: motd
  user:
    name: "{{ ansible_remote_user }}"
    groups: video
    append: yes
